<h1 class=" font-bold">Public Chat Room <img src="/chat_room.png" /></h1>
<section class="glass-borders"
    style="background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('/msgbg.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat;">
    <form id="form" class="p-4 message-box h-[90vh] flex flex-col justify-between ">
        <div class="overflow-y-auto ">
            <ul id="messages">
                <% chats.forEach(chat=> { %>
                    <li class="my-2">

                        <div class="flex flex-col">
                            <span>
                                <%= chat.sender.username%>
                                    <strong class="block">
                                        <%= chat.message %>
                                    </strong>
                            </span>

                        </div>
                    </li>
                    <% }) %>
            </ul>
        </div>
        <div class="flex gap-2">
            <input type="text" id="message-input" class="outline-none bg-transparent aero-borders w-full p-2 rounded-sm"
              >
            <button type="submit" class="styled-button">Send</button>
        </div>

    </form>



</section>


<script>
    const socket = new WebSocket(`ws://${window.location.host}`)
    const form = document.getElementById('form')
    const input = document.getElementById("message-input")
    const messages = document.getElementById("messages")

    const user = "<%= user.username %>"

    // send message to the server
    socket.onopen = () => {
        // socket.send("<%= user.username %> joined the chat.")
        socket.send(JSON.stringify({
            type: 'join',
            broadcast: 'public',
            user: {
                username: "<%= user.username %>",
                id: parseInt("<%= user.id %>")
            }
        }))
    }

    // receive message from the server
    socket.onmessage = (event) => {
        const li = document.createElement('li');
        console.log(event)
        const data = JSON.parse(event.data)
        if (data.type == 'chat') {
            let username = data.message.split(":")[0]
            const message = data.message.split(":")[1];

            li.innerHTML = `<div class="flex flex-col gap-1">
                <span>${user}</span>
                <strong>${message}</strong>
            </div>`

            messages.append(li)
        } else {
            li.innerHTML = data.message
            messages.append(li)
        }


    }

    form.addEventListener("submit", (e) => {
        e.preventDefault();
        const message = input.value;

        socket.send(JSON.stringify({ type: 'chat', broadcast: 'public', user, message }))

        input.value = ''
    })


</script>