<section class="h-[100vh] flex justify-between  gap-2">

    <div class="h-full flex flex-col w-[300px]  border border-gray-200">

        <div class="w-full px-4 py-6 bg-blue-600 flex flex-col">
            <span class="text-gray-50 font-bold"><%= chat_with.username %></span>
            <span class="text-gray-400 text-xs "><%= chat_with.createdAt %></span>
        </div>


        <div class="bg-gray-100 p-2">
            <span class="text-gray-400 text-sm">ID: <%= chat_with.id_number %> </span>
        </div>

    </div>

    <form id="form" class="flex-1 shadow-md  bg-white rounded-sm sm:w-1/2  flex flex-col gap-4 justify-between">
        <!-- <div class="flex gap-2">
            <a href="/users/dashboard" class="box p-2 rounded-sm hover:shadow-md"><i>back</i></a>
            <h1 class="text-3xl font-bold">Chatting with: <%= chat_with.username %>
            </h1>
        </div> -->
        <div class="overflow-y-scroll flex-1">
            <ul id="messages" class="flex  flex-col">
                <% chats.forEach((chat)=> { %>
                    <li class="p-4 border-t-1  border-gray-300 flex flex-col text-gray-800">
                        <div class="flex flex-row justify-between">
                            <span class="text-gray-400 text-sm"><%= chat.sender.username %></span>
                            <span class="text-xs text-gray-400" id="date"><%= chat.createdAt %></span>
                        </div>
                        <%= chat.message %>
                    </li>
                    <% })%>

            </ul>

            <pre>
            </pre>

        </div>
        <div class="flex gap-2 py-2 px-4">
            <input type="text" id="message-input" class="flex-1 p-2 border border-gray-200 outline-none rounded-lg"
                placeholder="Enter a message">
            <button type="submit" class="p-2 box text-black cursor-pointer rounded-lg">Send</button>
        </div>

    </form>
</section>

<script>

    const form = document.getElementById("form")
    const input = document.getElementById("message-input")
    const socket = new WebSocket(`ws://${window.location.host}`)
    const messages = document.getElementById("messages")
    const date = document.getElementById("date")


    socket.onopen = () => {
        socket.send(JSON.stringify({
            type: 'join',
            broadcast: 'private',
            user: {
                username: "<%= user.username %>",
                id: parseInt("<%= user.id %>")
            }
        }))
        console.log("connected")
    }

    socket.onmessage = (event) => {
        const li = document.createElement("li");
        const data = JSON.parse(event.data)
        // li.innerHTML = 

        console.log(data)


        li.innerHTML = `<span class="bg-yellow-200 p-1 rounded-sm">${data.from.username}</span> ${data.message}`
        messages.append(li)
        input.value = ''

    }

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const message = input.value;

        socket.send(JSON.stringify({
            type: 'chat',
            broadcast: 'private',
            message,
            sender: JSON.stringify("<%= user %>"),
            receiver: parseInt("<%= chat_with.id  %>")
        }))

        const li = document.createElement("li");
        li.innerHTML = `<span class="bg-green-200 p-1 rounded-sm"><%= user.username %></span> ${message}`
        messages.append(li)
        input.value = ''
    })



</script>